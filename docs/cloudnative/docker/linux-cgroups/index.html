<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-cloudnative/docker/linux-cgroups" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Linux Cgroups | 黄昏别馆</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://idukelu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://idukelu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://idukelu.com/docs/cloudnative/docker/linux-cgroups/"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Linux Cgroups | 黄昏别馆"><meta data-rh="true" name="description" content="什么是 Linux Cgroups ？"><meta data-rh="true" property="og:description" content="什么是 Linux Cgroups ？"><link data-rh="true" rel="icon" href="https://github.com/idukelu.png"><link data-rh="true" rel="canonical" href="https://idukelu.com/docs/cloudnative/docker/linux-cgroups/"><link data-rh="true" rel="alternate" href="https://idukelu.com/docs/cloudnative/docker/linux-cgroups/" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://idukelu.com/docs/cloudnative/docker/linux-cgroups/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="黄昏别馆 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="黄昏别馆 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.b3c33adb.css">
<script src="/assets/js/runtime~main.d81e23d4.js" defer="defer"></script>
<script src="/assets/js/main.89a9f58a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="https://github.com/idukelu.png" alt="Sunset Manor" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="https://github.com/idukelu.png" alt="Sunset Manor" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">黄昏别馆</b></a><a class="navbar__item navbar__link" href="/docs/golang/">Golang</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/cloudnative/docker/">云原生</a><a class="navbar__item navbar__link" href="/docs/database/mysql/">数据库</a><a class="navbar__item navbar__link" href="/docs/algorithm/sort/">算法</a><a class="navbar__item navbar__link" href="/blog/">随笔</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">其他</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/java/java-collections/">Java</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/cloudnative/docker/">Docker</a><button aria-label="折叠侧边栏分类 &#x27;Docker&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloudnative/docker/docker-install/">Docker 的安装与卸载</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloudnative/docker/image-acceleration/">Docker 镜像加速</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloudnative/docker/software-install/">常用软件安装</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloudnative/docker/linux-namespace/">Linux Namespace</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/cloudnative/docker/linux-cgroups/">Linux Cgroups</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloudnative/docker/linux-veth-pair/">Linux Veth Pair</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/cloudnative/kubernetes/">Kubernetes</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/cloudnative/docker/"><span itemprop="name">Docker</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Linux Cgroups</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Linux Cgroups</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="什么是-linux-cgroups-">什么是 Linux Cgroups ？<a href="#什么是-linux-cgroups-" class="hash-link" aria-label="什么是 Linux Cgroups ？的直接链接" title="什么是 Linux Cgroups ？的直接链接">​</a></h2>
<blockquote>
<p>Control groups, usually referred to as cgroups, are a Linux kernel feature which allow processes to be organized into hierarchical groups whose usage of various types of resources can then be limited and monitored. The kernel&#x27;s cgroup interface is provided through a pseudo-filesystem called cgroupfs. Grouping is implemented in the core cgroup kernel code, while resource tracking and limits are implemented in a set of per-resource-type subsystems (memory, CPU, and so on).</p>
</blockquote>
<p>Cgroups（Control Groups）是 linux 内核提供的一种机制，用来对一组进程及未来子进程的资源进行限制和管理。这些资源包括CPU、内存、存储、网络等。通过Cgroups，可以方便地限制某个进程的资源占用，并且可以实时地监控进程的监控和统计信息。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</div><div class="admonitionContent_BuS1"><p>Cgroups（Control Groups）是 Linux 内核提供的一种机制，用于限制和记录进程组的资源使用情况（如 CPU、内存、磁盘 I/O 等。</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="linux-cgroups-的主要功能">Linux Cgroups 的主要功能<a href="#linux-cgroups-的主要功能" class="hash-link" aria-label="Linux Cgroups 的主要功能的直接链接" title="Linux Cgroups 的主要功能的直接链接">​</a></h2>
<ul>
<li>资源限制：Cgroups 可以限制某个组中进程所使用的资源量，比如 CPU 时间、内存、磁盘 I/O 带宽等。这样可以防止某些进程过度消耗资源，影响系统的整体性能。</li>
<li>优先级控制：Cgroups 允许设置不同组的资源使用优先级。例如，可以为重要的进程分配更多的 CPU 时间，而为次要进程分配较少的资源。</li>
<li>审计和监控：可以通过 Cgroups 对资源使用情况进行监控和统计，了解每个组的资源消耗情况，从而帮助系统管理员进行资源优化和故障排查。</li>
<li>隔离：Cgroups 提供进程间的资源隔离，确保一个组中的进程不会干扰到另一个组的进程。例如，在容器技术中，Cgroups 被广泛用于实现容器之间的资源隔离。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="linux-cgroups-组成">Linux Cgroups 组成<a href="#linux-cgroups-组成" class="hash-link" aria-label="Linux Cgroups 组成的直接链接" title="Linux Cgroups 组成的直接链接">​</a></h2>
<blockquote>
<p>Cgroups are similar to processes in that: they are hierarchical, andchild cgroups inherit certain attributes from their parent cgroup.<br>
Multiple separate hierarchies of cgroups are necessary because each hierarchy is attached to one or more subsystems. A subsystem represents a single resource, such as CPU time or memory.</p>
</blockquote>
<p>Cgroup 与进程的相似之处在于：它们是分层的，并且子 cgroup 从其父 cgroup 继承某些属性。
多个单独的 cgroup 层次结构是必要的，因为每个层次结构都附加到一个或多个子系统。 子系统代表单个资源，例如 CPU 时间或内存等。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</div><div class="admonitionContent_BuS1"><p>可以简单理解为：</p><ul>
<li>cgroups 使用多个树形的 <em>层次结构(hierarchy)</em> 来组织和管理资源</li>
<li>一个 <em>层次结构(hierarchy)</em> 是由多个 <em>子 cgroup</em> 节点组成的树形结构</li>
<li><em>子 cgroup</em> 可以从其 <em>父 cgroup</em> 继承某些属性</li>
<li>每个 <em>层次结构(hierarchy)</em> 都可以附加到一个或多个 <em>子系统(subsystem)</em></li>
<li>子系统(subsystem) 代表单个资源，例如 CPU 时间或内存等</li>
</ul><p>即 cgroups = cgroup 树(hierarchy) + 子系统(subsystem)</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="层次结构hierarchy">层次结构(hierarchy)<a href="#层次结构hierarchy" class="hash-link" aria-label="层次结构(hierarchy)的直接链接" title="层次结构(hierarchy)的直接链接">​</a></h3>
<blockquote>
<p>The cgroups for a controller are arranged in a hierarchy. This hierarchy is defined by creating, removing, and renaming subdirectories within the cgroup filesystem. At each level of the hierarchy, attributes (e.g., limits) can be defined. The limits, control, and accounting provided by cgroups generally have effect throughout the subhierarchy underneath the cgroup where the attributes are defined. Thus, for example, the limits placed on a cgroup at a higher level in the hierarchy cannot be exceeded by descendant cgroups.</p>
</blockquote>
<p>cgroups 控制器的层级结构 (hierarchy) 是通过在 cgroup 文件系统中创建、删除和重命名子目录来定义的。在层级的每一级，可以定义属性（如限制）。这些限制和控制会影响到该 cgroup 及其子层级。因此，设置在上层 cgroup 的限制会影响到所有下级 cgroup，下级 cgroup 无法超越上层的限制。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</div><div class="admonitionContent_BuS1"><p>层次结构(hierarchy): 由多个 <em>子 cgroup</em> 节点组成的树形结构。</p></div></div>
<p>通过创建一个 cgroup 树便可很清晰的理解：</p>
<ul>
<li>
<p>创建并挂载 cgroup 根节点</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">~ </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> cgroup-root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">~ </span><span class="token function" style="color:#d73a49">mount</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-t</span><span class="token plain"> cgroup </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> none,name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cgroup-root cgroup-root ./cgroup-root</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">~ tree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cgroup-root/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── cgroup.clone_children</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── cgroup.event_control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── cgroup.procs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── cgroup.sane_behavior</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── notify_on_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── release_agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── tasks</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>创建两个字节点</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">~ </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> cgroup-node1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">~ </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> cgroup-node2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">~ tree</span><br></span><span class="token-line code-block-highlighting-line" style="color:#393A34"><span class="token plain">cgroup-root/ </span><span class="token comment" style="color:#999988;font-style:italic">## cgroup 根节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── cgroup.clone_children</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── cgroup.event_control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── cgroup.procs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── cgroup.sane_behavior</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── notify_on_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── release_agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── tasks</span><br></span><span class="token-line code-block-highlighting-line" style="color:#393A34"><span class="token plain">├── cgroup-node1 </span><span class="token comment" style="color:#999988;font-style:italic">## cgroup 子节点1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── cgroup.clone_children</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── cgroup.event_control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── cgroup.procs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── notify_on_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── tasks</span><br></span><span class="token-line code-block-highlighting-line" style="color:#393A34"><span class="token plain">└── cgroup-node2 </span><span class="token comment" style="color:#999988;font-style:italic">## cgroup 子节点2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── cgroup.clone_children</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── cgroup.event_control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── cgroup.procs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── notify_on_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── tasks</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>下面是对每个文件作用的说明：</p>
<ol>
<li><strong>cgroup.clone_children</strong>：控制新创建的子 cgroup 是否继承当前 cgroup 的属性。如果设置为 1，则子 cgroup 会继承当前 cgroup 的资源限制和控制。</li>
<li><strong>cgroup.event_control</strong>：事件控制文件，用于 cgroup 事件通知机制。可以用来监控 cgroup 的事件，比如当某个 cgroup 的进程数量发生变化时，系统会通过这个机制进行通知。</li>
<li><strong>cgroup.procs</strong>：包含当前 cgroup 中所有进程的 PID。向这个文件写入一个 PID，可以将该进程加入到当前 cgroup 中。</li>
<li><strong>cgroup.sane_behavior</strong>：用于控制 cgroup 的行为模式。设置为 1 时，cgroup 将采用一种合理的默认行为，这通常涉及一些优化和改进，使得 cgroup 的行为更符合预期。</li>
<li><strong>notify_on_release</strong>：用于控制是否在 cgroup 被释放时触发一个用户定义的操作。如果设置为 1，当 cgroup 中的最后一个任务结束时，将会调用 <code>release_agent</code> 文件中指定的脚本或命令。</li>
<li><strong>release_agent</strong>：指定了一个脚本或命令，当一个 cgroup 被释放（即 cgroup 中的最后一个任务结束并且 <code>notify_on_release</code> 被设置为 1）时，会执行这个脚本或命令。</li>
<li><strong>tasks</strong>：类似于 <code>cgroup.procs</code>，也包含当前 cgroup 中所有进程的 PID。不同之处在于 <code>tasks</code> 文件包含的是任务（包括线程）的 PID，而 <code>cgroup.procs</code> 仅包含进程的 PID。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="子系统subsystem">子系统(subsystem)<a href="#子系统subsystem" class="hash-link" aria-label="子系统(subsystem)的直接链接" title="子系统(subsystem)的直接链接">​</a></h3>
<blockquote>
<p>A subsystem is a kernel component that modifies the behavior of the processes in a cgroup. Various subsystems have been implemented, making it possible to do things such as limiting the amount of CPU time and memory available to a cgroup, accounting for the CPU time used by a cgroup, and freezing and resuming execution of the processes in a cgroup. Subsystems are sometimes also known as resource controllers (or simply, controllers).</p>
</blockquote>
<p>子系统 (subsystem) 是内核组件，用于修改 cgroup 中进程的行为。不同的子系统实现了多种功能，例如限制 cgroup 可用的 CPU 时间和内存量、记录 cgroup 使用的 CPU 时间，以及冻结和恢复 cgroup 中进程的执行。子系统有时也称为资源控制器（或简称控制器）。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</div><div class="admonitionContent_BuS1"><p>子系统(subsystem): 用于限制和监控某种特定资源的模块。</p></div></div>
<p>可以通过下面的命令，查看内核支持哪些子系统 (subsystem) ：</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /proc/cgroups</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#subsys_name    hierarchy	num_cgroups     enabled</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpuset          </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpu             </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">	        </span><span class="token number" style="color:#36acaa">61</span><span class="token plain">              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpuacct	        </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">	        </span><span class="token number" style="color:#36acaa">61</span><span class="token plain">              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">memory	        </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">	        </span><span class="token number" style="color:#36acaa">58</span><span class="token plain">              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">devices	        </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">	        </span><span class="token number" style="color:#36acaa">57</span><span class="token plain">              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">freezer	        </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">	        </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net_cls	        </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">	        </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blkio	        </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">	        </span><span class="token number" style="color:#36acaa">57</span><span class="token plain">              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">perf_event      </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">	        </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hugetlb	        </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">	        </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pids	        </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">	        </span><span class="token number" style="color:#36acaa">57</span><span class="token plain">              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net_prio        </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">	        </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><strong>cpuset</strong>：管理和分配 CPU 和内存节点（NUMA节点）。通过 cpuset 控制器，用户可以将任务绑定到特定的 CPU 和内存节点，以优化性能和资源使用。</li>
<li><strong>cpu</strong>：通过设置 CPU 共享、权重和调度参数来控制和限制 cgroup 使用的 CPU 时间。它可以用于保证不同 cgroup 之间的公平资源分配。</li>
<li><strong>cpuacct</strong>：提供 CPU 资源使用的统计信息。它记录每个 cgroup 使用的 CPU 时间，方便系统管理员监控和审计资源使用情况。</li>
<li><strong>memory</strong>：限制和监控 cgroup 使用的内存，包括物理内存和交换空间。它可以防止某个 cgroup 过度使用内存资源，从而影响系统稳定性。</li>
<li><strong>devices</strong>：控制 cgroup 中的任务可以访问哪些设备。它可以允许或禁止对特定设备的访问，从而提高系统安全性和资源隔离。</li>
<li><strong>freezer</strong>：允许冻结和恢复 cgroup 中的任务。冻结操作暂停 cgroup 中的所有任务，恢复操作重新启动它们。这对于调试和系统维护非常有用。</li>
<li><strong>net_cls</strong>：通过为网络数据包打上标签，允许对来自不同 cgroup 的流量进行分类和控制。它可以用于网络流量控制和流量监控。</li>
<li><strong>blkio</strong>：限制和监控 cgroup 使用的块设备 I/O（如磁盘 I/O）。它可以设置 I/O 权重和限制，以防止某个 cgroup 过度使用磁盘资源。</li>
<li><strong>perf_event</strong>：允许对 cgroup 中的任务进行性能监控。它可以收集各种性能事件的数据，如 CPU 周期、指令数等，用于性能分析和调优。</li>
<li><strong>hugetlb</strong>：管理和分配大页面内存（hugepages）。大页面可以提高内存密集型应用的性能，通过减少 TLB（Translation Lookaside Buffer）失效次数。</li>
<li><strong>pids</strong>：限制和监控 cgroup 中的任务数量（进程和线程）。它可以防止某个 cgroup 生成过多进程，从而影响系统的稳定性。</li>
<li><strong>net_prio</strong>：设置 cgroup 中任务的网络流量优先级。它可以用于对不同 cgroup 的网络流量进行优先级排序，保证关键任务的网络带宽。</li>
</ul>
<p>实际上，系统默认已经为每个 subsystem 创建了一个默认的 hierarchy (cgroup 树)，方便用户后续使用：</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">～ ll /sys/fs/cgroup/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blkio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpu -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> cpu,cpuacct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpuacct -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> cpu,cpuacct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpu,cpuacct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpuset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">devices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">freezer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hugetlb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net_cls -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> net_cls,net_prio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net_cls,net_prio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net_prio -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> net_cls,net_prio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">perf_event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pids</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="linux-cgroups-在-docker-中的使用">Linux Cgroups 在 Docker 中的使用<a href="#linux-cgroups-在-docker-中的使用" class="hash-link" aria-label="Linux Cgroups 在 Docker 中的使用的直接链接" title="Linux Cgroups 在 Docker 中的使用的直接链接">​</a></h2>
<p>使用 <code>docker run</code> 时，指定下面的 flag 即可对相关资源进行控制：</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## cpu 限制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-c, --cpu-shares int                   CPU shares </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">relative weight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token parameter variable" style="color:#36acaa">--cpus</span><span class="token plain"> decimal                     Number of CPUs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cpuset-cpus string               CPUs </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">which</span><span class="token plain"> to allow execution </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">-3, </span><span class="token number" style="color:#36acaa">0,1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cpuset-mems string               MEMs </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">which</span><span class="token plain"> to allow execution </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">-3, </span><span class="token number" style="color:#36acaa">0,1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## 内存限制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-m, </span><span class="token parameter variable" style="color:#36acaa">--memory</span><span class="token plain"> bytes                     Memory limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --memory-reservation bytes         Memory soft limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --memory-swap bytes                Swap limit equal to memory plus swap: </span><span class="token string" style="color:#e3116c">&#x27;-1&#x27;</span><span class="token plain"> to </span><span class="token builtin class-name">enable</span><span class="token plain"> unlimited swap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --memory-swappiness int            Tune container memory swappiness </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default -1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## IO 限制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --blkio-weight uint16              Block IO </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">relative weight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, between </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> and </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain">, or </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> to disable </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --blkio-weight-device list         Block IO weight </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">relative device weight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --device-read-bps list             Limit </span><span class="token builtin class-name">read</span><span class="token plain"> rate </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bytes per second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from a device </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --device-read-iops list            Limit </span><span class="token builtin class-name">read</span><span class="token plain"> rate </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IO per second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from a device </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --device-write-bps list            Limit </span><span class="token function" style="color:#d73a49">write</span><span class="token plain"> rate </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bytes per second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> to a device </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --device-write-iops list           Limit </span><span class="token function" style="color:#d73a49">write</span><span class="token plain"> rate </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IO per second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> to a device </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## 进程数限制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --pids-limit int                   Tune container pids limit </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">set </span><span class="token parameter variable" style="color:#36acaa">-1</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> unlimited</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## 用户限制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token parameter variable" style="color:#36acaa">--ulimit</span><span class="token plain"> </span><span class="token builtin class-name">ulimit</span><span class="token plain">                    Ulimit options </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们启动一个容器，看看 Docker 是如何通过 Cgroups 限制相关资源的：</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">~ </span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run </span><span class="token parameter variable" style="color:#36acaa">-d</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-m</span><span class="token plain"> 128m nginx</span><br></span><span class="token-line code-block-highlighting-line" style="color:#393A34"><span class="token plain">93aa71954a4693dbbf6c406b8f8562f9463875eae2e2b713921ae3268d521858</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>查看对应容器的 cgroup 节点</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line code-block-highlighting-line" style="color:#393A34"><span class="token plain">~ ll /sys/fs/cgroup/memory/docker/93aa71954a4693dbbf6c406b8f8562f9463875eae2e2b713921ae3268d521858/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cgroup.clone_children</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cgroup.event_control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cgroup.procs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line code-block-highlighting-line" style="color:#393A34"><span class="token plain">memory.limit_in_bytes</span><br></span><span class="token-line code-block-highlighting-line" style="color:#393A34"><span class="token plain">memory.max_usage_in_bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notify_on_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tasks</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>查看容器内存情况</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## 容器内存限制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">~ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /sys/fs/cgroup/memory/docker/93aa71954a4693dbbf6c406b8f8562f9463875eae2e2b713921ae3268d521858/memory.limit_in_bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">134217728</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## 容器中进程使用的内存大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">~ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /sys/fs/cgroup/memory/docker/93aa71954a4693dbbf6c406b8f8562f9463875eae2e2b713921ae3268d521858/memory.max_usage_in_bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4296704</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看出，Docker 会为每个容器创建 cgroup 节点，并通过 cgroup 配置实现资源的限制和监控。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>Linux Cgroups: Linux 内核提供的一种机制，用于<strong>限制和记录进程组的资源使用情况</strong>。</p>
<p>Linux Cgroups 组成：层次结构(hierarchy) + 子系统(subsystem)</p>
<ul>
<li>层次结构(hierarchy): 由多个 <em>子 cgroup</em> 节点组成的树形结构。</li>
<li>子系统(subsystem): 用于限制和监控某种特定资源的模块。</li>
</ul>
<p>Linux Cgroups 在 Docker 中的应用：</p>
<ul>
<li>使用 <code>docker run</code> 命令时，指定对应的 flag 限制相关资源</li>
<li>Docker 会为每个容器创建 cgroup 节点，并通过 cgroup 配置实现资源的限制和监控</li>
<li>相关容器的 cgroup 节点在 <code>/sys/fs/cgroup/{资源类型}/docker/{容器ID}</code></li>
</ul>
<hr>
<p>参考：</p>
<ul>
<li><a href="https://lwn.net/Articles/604609/" target="_blank" rel="noopener noreferrer">Control groups series by Neil Brown</a></li>
<li><a href="https://man.archlinux.org/man/cgroups.7.en" target="_blank" rel="noopener noreferrer">man 7 cgroups</a></li>
<li><a href="https://wiki.archlinux.org/title/cgroups" target="_blank" rel="noopener noreferrer">cgroups - archlinux wiki</a></li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/ch01#doc-wrapper" target="_blank" rel="noopener noreferrer">Resource Management Guide - redhat</a></li>
<li><a href="https://zh.wikipedia.org/zh-hans/Cgroups" target="_blank" rel="noopener noreferrer">Linux Cgroups - 维基百科</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/云原生/">云原生</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/docker/">Docker</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/cloudnative/docker/linux-namespace/"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Linux Namespace</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/cloudnative/docker/linux-veth-pair/"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Linux Veth Pair</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#什么是-linux-cgroups-" class="table-of-contents__link toc-highlight">什么是 Linux Cgroups ？</a></li><li><a href="#linux-cgroups-的主要功能" class="table-of-contents__link toc-highlight">Linux Cgroups 的主要功能</a></li><li><a href="#linux-cgroups-组成" class="table-of-contents__link toc-highlight">Linux Cgroups 组成</a><ul><li><a href="#层次结构hierarchy" class="table-of-contents__link toc-highlight">层次结构(hierarchy)</a></li><li><a href="#子系统subsystem" class="table-of-contents__link toc-highlight">子系统(subsystem)</a></li></ul></li><li><a href="#linux-cgroups-在-docker-中的使用" class="table-of-contents__link toc-highlight">Linux Cgroups 在 Docker 中的使用</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 iDukeLu, Inc.</div></div></div></footer></div>
</body>
</html>